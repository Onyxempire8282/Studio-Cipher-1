<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Route Cipher - Claim Cipher</title>
    <!-- Universal System - Base styling -->
    <link rel="stylesheet" href="styles/universal-system.css" />

    <!-- Page Layout - Route Cypher specific -->
    <link rel="stylesheet" href="styles/route-cypher-layout.css" />

    <!-- Professional Calculator Interface -->
    <link rel="stylesheet" href="styles/professional-calculator.css" />

    <!-- Route Cipher Professional Styling -->
    <link rel="stylesheet" href="styles/route-cipher-professional.css" />
  </head>
  <body class="route-page">
    <header class="cipher-header">
      <div class="header-content">
        <div class="app-brand">
          <span class="logo">üé§</span>
          <span>Claim Cipher</span>
        </div>
        <div class="nav-links">
          <a href="command-center.html">üéØ Dashboard</a>
          <a href="route-cypher.html" class="active">üó∫Ô∏è Routes</a>
          <a href="mileage-cypher.html">üßÆ Mileage</a>
          <a href="jobs-studio.html">üíº Jobs</a>
          <a href="total-loss-forms.html">üöó Forms</a>
          <a href="firms-directory.html">üè¢ Firms</a>
          <a href="settings-booth.html">‚öôÔ∏è Settings</a>
          <a href="functionality-test.html">üß™ Tests</a>
        </div>
        <div class="user-section">
          <div class="user-info">
            <div class="user-name" id="userName">Professional User</div>
            <div class="user-role">Claims Specialist</div>
          </div>
          <button
            class="logout-btn cipher-btn cipher-btn--danger"
            onclick="handleLogout()"
          >
            Logout
          </button>
        </div>
      </div>
    </header>

    <main class="route-optimizer-main main-content">
      <div class="route-container">
        <!-- Left Panel: Input + Results -->
        <div class="input-and-results-panel">
          <!-- Route Optimizer Section -->
          <div class="optimizer-section cipher-glass-panel">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">üó∫Ô∏è</span>
                <h2>Route Optimizer</h2>
              </div>
              <div class="section-subtitle">
                Plan efficient multi-stop routes with intelligent day splitting
              </div>
            </div>

            <div class="optimizer-form">
              <div class="form-section">
                <h3 class="form-section-title">
                  <span class="form-icon">üéØ</span>
                  Starting Location
                </h3>
                <div class="input-group">
                  <label for="startLocation" class="input-label">
                    <span class="label-icon">üè†</span>
                    Starting Point
                  </label>
                  <input
                    type="text"
                    id="startLocation"
                    class="route-input"
                    placeholder="Enter your starting address..."
                  />
                  <div class="input-hint">
                    Your starting location will be saved for future use
                  </div>
                </div>
              </div>

              <div class="form-section drop-zone-section">
                <h3 class="form-section-title">
                  <span class="form-icon">üéØ</span>
                  Dropped Claims
                </h3>
                <div id="claimDropZone" class="claim-drop-zone">
                  <div class="drop-zone-empty-state">
                    <span class="empty-icon">üì¶</span>
                    <p>Drop claims here from Cipher Dispatch</p>
                    <button id="pasteClaimsBtn" class="secondary-btn">
                      <span class="btn-icon">üìã</span>
                      Paste Claims (Mobile)
                    </button>
                  </div>
                </div>
                <div class="drop-zone-actions" style="display: none;">
                  <button id="clearClaims" class="secondary-btn">Clear All</button>
                  <button id="routeClaims" class="primary-action-btn" disabled>
                    <span class="btn-icon">üöÄ</span>
                    <span class="route-claims-text">Route Claims</span>
                  </button>
                </div>
              </div>

              <div class="form-section">
                <h3 class="form-section-title">
                  <span class="form-icon">üìç</span>
                  Destinations
                </h3>
                <div class="destinations-group">
                  <div class="destinations-header">
                    <div class="destinations-label">
                      Add up to 15 destinations
                    </div>
                    <button id="addDestination" class="secondary-btn">
                      <span class="btn-icon">‚ûï</span>
                      Add Stop
                    </button>
                  </div>
                  <div id="destinationsList" class="destinations-list">
                    <div class="destination-input">
                      <input
                        type="text"
                        placeholder="Enter destination address"
                        class="destination-address-input"
                      />
                      <div class="destination-controls">
                        <select
                          class="priority-select"
                          title="Set priority level"
                        >
                          <option value="normal">üîµ Normal</option>
                          <option value="high">üü° High</option>
                          <option value="urgent">üî¥ Urgent</option>
                        </select>
                        <button
                          class="remove-btn"
                          onclick="removeDestination(this)"
                          title="Remove this destination"
                        >
                          √ó
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-section">
                <h3 class="form-section-title">
                  <span class="form-icon">‚öôÔ∏è</span>
                  Quick Settings
                </h3>
                <div class="quick-settings-bar">
                  <div class="quick-setting">
                    <label for="territoryType" class="quick-label"
                      >Territory:</label
                    >
                    <select id="territoryType" class="quick-select">
                      <option value="rural">Rural (Distance Priority)</option>
                      <option value="urban">Urban (Time Priority)</option>
                      <option value="mixed">Mixed Territory</option>
                    </select>
                  </div>
                  <div class="quick-setting">
                    <label class="modern-checkbox compact-checkbox">
                      <input
                        type="checkbox"
                        id="geographicClustering"
                        checked
                      />
                      <span class="checkbox-custom small"></span>
                      <span class="checkbox-label-text">
                        <span class="checkbox-title"
                          >Geographic Clustering</span
                        >
                      </span>
                    </label>
                  </div>
                  <div class="quick-setting">
                    <label for="maxDailyHours" class="quick-label"
                      >Max Hours:</label
                    >
                    <select id="maxDailyHours" class="quick-select">
                      <option value="6">6 hours</option>
                      <option value="8" selected>8 hours</option>
                      <option value="10">10 hours</option>
                    </select>
                  </div>
                  <div class="quick-setting">
                    <button id="toggleAdvanced" class="toggle-advanced-btn">
                      <span class="btn-icon">‚öôÔ∏è</span>
                      More Settings
                    </button>
                  </div>
                </div>

                <!-- Advanced Settings (Collapsed by Default) -->
                <div
                  id="advancedSettings"
                  class="advanced-settings"
                  style="display: none"
                >
                  <div class="settings-grid">
                    <div class="setting-group">
                      <label class="modern-checkbox">
                        <input type="checkbox" id="optimizeEnabled" checked />
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-label-text">
                          <span class="checkbox-title">Route Optimization</span>
                          <span class="checkbox-subtitle"
                            >Find the most efficient route order</span
                          >
                        </span>
                      </label>
                    </div>

                    <div class="setting-group">
                      <label class="modern-checkbox">
                        <input type="checkbox" id="splitEnabled" checked />
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-label-text">
                          <span class="checkbox-title"
                            >Intelligent Day Splitting</span
                          >
                          <span class="checkbox-subtitle"
                            >Automatically split routes across multiple
                            days</span
                          >
                        </span>
                      </label>
                    </div>
                  </div>

                  <div class="parameters-grid">
                    <div class="input-group">
                      <label for="maxLegMiles" class="input-label"
                        >Max Miles Per Leg</label
                      >
                      <input
                        type="number"
                        id="maxLegMiles"
                        value="50"
                        min="1"
                        max="500"
                        class="distance-input"
                      />
                    </div>

                    <div class="input-group">
                      <label for="maxStopsPerDay" class="input-label"
                        >Max Stops Per Day</label
                      >
                      <input
                        type="number"
                        id="maxStopsPerDay"
                        value="6"
                        min="1"
                        max="20"
                        class="distance-input"
                      />
                    </div>

                    <div class="input-group">
                      <label for="timePerAppointment" class="input-label"
                        >Time Per Stop (minutes)</label
                      >
                      <input
                        type="number"
                        id="timePerAppointment"
                        value="30"
                        min="5"
                        max="180"
                        class="distance-input"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button id="optimizeRoute" class="primary-action-btn">
                  <span class="btn-icon">üöÄ</span>
                  <span class="btn-text">Optimize Route</span>
                  <span class="btn-loading" style="display: none">
                    <span class="loading-spinner"></span>
                    Optimizing...
                  </span>
                </button>
              </div>
            </div>
          </div>

          <!-- Results Section -->
          <div
            class="results-section cipher-glass-panel"
            id="routeResults"
            style="display: none"
          >
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">üéØ</span>
                <h2>Route Analysis & Scheduling</h2>
              </div>
            </div>

            <div class="results-content">
              <div id="routeOutput" class="route-output"></div>

              <div class="route-actions">
                <button id="copyRoute" class="copy-btn">
                  <span class="btn-icon">üìã</span>
                  Copy
                </button>
                <button id="exportMiles" class="secondary-btn">
                  <span class="btn-icon">üìä</span>
                  Mileage
                </button>
              </div>

              <div class="calendar-export-section">
                <h3 class="export-title">
                  <span class="export-icon">üìÖ</span>
                  Schedule Appointments
                </h3>
                <div class="export-actions">
                  <button
                    id="exportGoogleCal"
                    class="calendar-export-btn"
                    disabled
                  >
                    <span class="btn-icon">üìÖ</span>
                    Google Calendar
                  </button>
                  <button
                    id="exportAppleCal"
                    class="calendar-export-btn"
                    disabled
                  >
                    <span class="btn-icon">üçé</span>
                    Apple Calendar
                  </button>
                  <button id="exportMobileCipher" class="primary-action-btn">
                    <span class="btn-icon">üì±</span>
                    Mobile Cipher
                  </button>
                </div>
                <div class="export-status">
                  <span id="exportStatus"
                    >Set appointment times above to enable calendar export</span
                  >
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Panel: Map Only -->
        <div class="map-only-panel">
          <!-- Map Container -->
          <div class="map-section cipher-glass-panel">
            <div class="section-header">
              <div class="section-title">
                <span class="section-icon">üó∫Ô∏è</span>
                <h2>Route Visualization</h2>
              </div>
              <div class="section-subtitle">
                Visual validation - "Do I want to drive that way?"
              </div>
            </div>
            <div class="map-container">
              <div id="routeMap"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Overlay -->
      <div id="loadingOverlay" class="loading-overlay" style="display: none">
        <div class="loading-content glass-card">
          <div class="spinner"></div>
          <p>üéµ Calculating optimal route...</p>
        </div>
      </div>

      <!-- Error Display -->
      <div id="errorDisplay" class="error-display" style="display: none">
        <p id="errorMessage"></p>
        <button onclick="hideError()" class="cipher-btn cipher-btn--sm">
          √ó
        </button>
      </div>
    </main>

    <!-- Route Map Modal -->
    <div id="routeMapModal" class="route-map-modal">
      <div class="modal-container">
        <!-- Modal Header -->
        <div class="modal-header">
          <div class="modal-title">
            <span>üó∫Ô∏è</span>
            <span>Route Visualization</span>
          </div>
          <button class="modal-close-btn" onclick="closeRouteModal()">√ó</button>
        </div>

        <!-- Day Tabs -->
        <div id="dayTabs" class="day-tabs">
          <!-- Tabs will be generated dynamically -->
        </div>

        <!-- Modal Content -->
        <div class="modal-content">
          <!-- Left: Timeline -->
          <div id="modalTimeline" class="modal-timeline">
            <!-- Timeline will be generated dynamically -->
          </div>

          <!-- Right: Map -->
          <div class="modal-map-container">
            <div id="modalMap" class="modal-map"></div>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer">
          <div class="modal-stats" id="modalStats">
            <!-- Stats will be shown here -->
          </div>
          <div class="modal-actions">
            <button
              class="modal-btn modal-btn-secondary"
              onclick="closeRouteModal()"
            >
              <span>üìù</span>
              <span>Edit Route</span>
            </button>
            <button
              class="modal-btn modal-btn-primary"
              onclick="exportRouteFromModal()"
            >
              <span>üìÖ</span>
              <span>Export Schedule</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Load API configuration first -->
    <script src="config/github-pages-env.js"></script>
    <script src="config/api-config-production.js"></script>

    <!-- Core Scripts (utilities only, no auth) -->
    <script src="scripts/cipher-core.js"></script>

    <!-- Google Maps Configuration -->
    <script src="scripts/google-config.js"></script>

    <!-- Google Maps API -->
    <script>
      // Load Google Maps API if key is configured
      if (
        window.GOOGLE_MAPS_CONFIG &&
        window.GOOGLE_MAPS_CONFIG.apiKey &&
        window.GOOGLE_MAPS_CONFIG.apiKey !==
          "CONFIGURE_YOUR_GOOGLE_MAPS_API_KEY"
      ) {
        const script = document.createElement("script");
        script.src = `https://maps.googleapis.com/maps/api/js?key=${
          window.GOOGLE_MAPS_CONFIG.apiKey
        }&libraries=${window.GOOGLE_MAPS_CONFIG.libraries.join(
          ","
        )}&callback=initRouteOptimizer`;
        script.async = true;
        script.defer = true;
        document.head.appendChild(script);
        console.log("üó∫Ô∏è Loading Google Maps API...");
      } else {
        console.warn(
          "üó∫Ô∏è Google Maps API key not configured, using fallback mode"
        );
        // Initialize without Google Maps
        setTimeout(() => {
          if (typeof RouteOptimizer !== "undefined") {
            window.routeOptimizer = new RouteOptimizer();
            console.log("üó∫Ô∏è Route Optimizer initialized in fallback mode");
          }
        }, 100);
      }
    </script>

    <!-- Route Optimizer Script -->
    <script src="scripts/route-optimizer.js"></script>

    <!-- Modal Control Functions -->
    <script>
      // Global functions for modal control
      function closeRouteModal() {
        const modal = document.getElementById("routeMapModal");
        modal.classList.remove("active");
        document.body.style.overflow = "";
      }

      function switchModalDay(dayIndex) {
        if (!window.routeOptimizer || !window.routeOptimizer.currentRoute) {
          console.error("No route data available");
          return;
        }

        // Update active tab
        document.querySelectorAll(".day-tab").forEach((tab, index) => {
          if (index === dayIndex) {
            tab.classList.add("active");
          } else {
            tab.classList.remove("active");
          }
        });

        // Show timeline and map for selected day
        window.routeOptimizer.showDayTimeline(
          dayIndex,
          window.routeOptimizer.currentRoute,
          window.routeOptimizer.currentOriginalRoute
        );
        window.routeOptimizer.renderModalDayRoute(
          window.routeOptimizer.currentRoute,
          dayIndex
        );
      }

      function exportRouteFromModal() {
        // TODO: Implement export functionality
        alert("Export functionality coming soon!");
      }
    </script>

    <!-- Security Agent: Google Maps API Script -->
    <script>
      // Security Agent: Global callback function
      function initRouteOptimizer() {
        console.log(
          "üîí Security Agent: Google Maps API loaded, initializing..."
        );

        try {
          if (typeof RouteOptimizer !== "undefined") {
            window.routeOptimizer = new RouteOptimizer();

            // Initialize Google Maps
            if (window.routeOptimizer && typeof google !== "undefined") {
              const mapContainer = document.getElementById("routeMap");
              if (mapContainer) {
                window.routeOptimizer.map = new google.maps.Map(mapContainer, {
                  zoom: 10,
                  center: { lat: 40.7128, lng: -74.006 },
                  mapTypeId: google.maps.MapTypeId.ROADMAP,
                });

                window.routeOptimizer.directionsService =
                  new google.maps.DirectionsService();
                window.routeOptimizer.directionsRenderer =
                  new google.maps.DirectionsRenderer({
                    draggable: true,
                    panel: document.getElementById("directionsPanel"),
                  });
                window.routeOptimizer.geocoder = new google.maps.Geocoder();

                window.routeOptimizer.directionsRenderer.setMap(
                  window.routeOptimizer.map
                );

                console.log(
                  "üîí Security Agent: Google Maps fully initialized!"
                );
              } else {
                console.error(
                  "üîí Security Agent: Map container #routeMap not found"
                );
              }
            }
          }
        } catch (error) {
          console.error("üîí Security Agent: Initialization error:", error);
        }
      }

      // Security Agent: Error handler for API failures
      function gm_authFailure() {
        console.error("üîí Security Agent: Google Maps authentication failed");
        document.getElementById("errorMessage").textContent =
          "Google Maps failed to load. Check API key.";
        document.getElementById("errorDisplay").style.display = "block";
      }
    </script>
  </body>
</html>
